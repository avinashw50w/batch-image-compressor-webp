<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Batch Image Compressor</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <h1><span class="rocket">ðŸš€</span> Batch Image Compressor</h1>
        <p>Drop files or a folder, adjust settings, and get a compressed zip file.</p>

        <form id="compressionForm">
            <div id="drop-area">Click or Drop Files/Folder Here</div>
            <input type="file" id="fileInput" name="images" multiple style="display: none;" webkitdirectory directory>
            
            <div class="settings-grid">
                <div class="setting-group">
                    <label>Max Width (px)</label>
                    <input type="number" name="maxWidth" value="1280" placeholder="Default: 1280">
                </div>
                <div class="setting-group">
                    <label>Max Height (px)</label>
                    <input type="number" name="maxHeight" value="1280" placeholder="Default: 1280">
                </div>
                <div class="setting-group">
                    <label>Quality (1-100)</label>
                    <input type="number" name="quality" value="80" placeholder="Default: 80">
                </div>
            </div>

            <p id="file-list-status">No files selected.</p>
            <button type="submit" id="compressBtn" disabled>Compress Images</button>
        </form>

        <div class="progress-section" style="display: none;" id="progress-section">
            <h2>Processing...</h2>
            <div id="progress-bar-container">
                <div id="progress-bar">0%</div>
            </div>
            <p id="progress-text">Status: Idle</p>
            <a id="download-link" style="display: none;"></a>
        </div>
    </div>

    <script>
        const dropArea = document.getElementById('drop-area');
        const fileInput = document.getElementById('fileInput');
        const form = document.getElementById('compressionForm');
        const compressBtn = document.getElementById('compressBtn');
        const fileListStatus = document.getElementById('file-list-status');
        const progressSection = document.getElementById('progress-section');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        const downloadLink = document.getElementById('download-link');
        
        let selectedFiles = [];
        let pendingTraversalOperations = 0;
        let zipFolderName = '';

        function isIgnoredFile(file) {
            return file.name.startsWith('.');
        }

        function updateFileListStatus() {
            const fileCount = selectedFiles.length;

            if (fileCount > 0) {
                fileListStatus.textContent = `${fileCount} file(s) selected.`;
                compressBtn.disabled = false;
                compressBtn.classList.add('active');
            } else {
                fileListStatus.textContent = 'No files selected.';
                compressBtn.disabled = true;
                compressBtn.classList.remove('active');
            }
        }

        dropArea.addEventListener('click', () => fileInput.click());

        fileInput.addEventListener('change', (e) => {
            selectedFiles = [];
            const allSelectedFiles = Array.from(e.target.files);
            selectedFiles = allSelectedFiles.filter(file => !isIgnoredFile(file));
            zipFolderName = '';

            if (selectedFiles.length > 0) {
                const firstFile = allSelectedFiles[0];
                
                if (firstFile.webkitRelativePath) {
                    const parts = firstFile.webkitRelativePath.split('/');
                    if (parts.length > 0) {
                        zipFolderName = parts[0];
                    }
                }
            }

            updateFileListStatus();
        });

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, (e) => {
                e.preventDefault();
                e.stopPropagation();
            });
        });

        ['dragenter', 'dragover'].forEach(eventName => {
            dropArea.addEventListener(eventName, () => dropArea.classList.add('highlight'));
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, () => dropArea.classList.remove('highlight'));
        });

        dropArea.addEventListener('drop', handleDrop);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            selectedFiles = [];
            pendingTraversalOperations = 0;
            zipFolderName = '';

            if (dt.items) {
                const firstEntry = [...dt.items][0].webkitGetAsEntry();
                
                if (firstEntry && firstEntry.isDirectory) {
                    zipFolderName = firstEntry.name;
                }

                [...dt.items].forEach(item => {
                    const entry = item.webkitGetAsEntry();
                    if (entry) {
                        pendingTraversalOperations++;
                        traverseFileTree(entry);
                    }
                });
            }
        }

        function onTraversalComplete() {
            pendingTraversalOperations--;
            if (pendingTraversalOperations <= 0) {
                updateFileListStatus();
            }
        }

        function traverseFileTree(item) {
            if (item.isFile) {
                item.file(file => {
                    if (!isIgnoredFile(file)) {
                        selectedFiles.push(file);
                    }
                    onTraversalComplete();
                });
            } else if (item.isDirectory) {
                const dirReader = item.createReader();
                
                const readEntries = () => {
                    dirReader.readEntries(entries => {
                        if (entries.length > 0) {
                            pendingTraversalOperations += entries.length;
                            entries.forEach(entry => traverseFileTree(entry));
                            readEntries();
                        } else {
                            onTraversalComplete();
                        }
                    });
                };
                readEntries();
            }
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            if (selectedFiles.length === 0) return;

            const formData = new FormData();
            selectedFiles.forEach(file => formData.append('images', file));
            formData.append('maxWidth', form.maxWidth.value);
            formData.append('maxHeight', form.maxHeight.value);
            formData.append('quality', form.quality.value);
            formData.append('zipFolderName', zipFolderName);

            progressSection.style.display = 'block';
            progressText.textContent = 'Status: Uploading and starting compression...';
            progressBar.style.width = '0%';
            progressBar.textContent = '0%';
            compressBtn.disabled = true;
            downloadLink.style.display = 'none';

            try {
                const startResponse = await fetch('/compress', {
                    method: 'POST',
                    body: formData
                });

                if (!startResponse.ok) throw new Error('Failed to start compression.');

                const { batchId } = await startResponse.json();
                
                const pollInterval = setInterval(async () => {
                    const progressResponse = await fetch(`/progress/${batchId}`);
                    if (!progressResponse.ok) {
                        clearInterval(pollInterval);
                        progressText.textContent = 'Status: Error fetching progress.';
                        return;
                    }

                    const progressData = await progressResponse.json();
                    
                    const progressPercent = progressData.progress;
                    progressBar.style.width = `${progressPercent}%`;
                    progressBar.textContent = `${progressPercent}%`;
                    progressText.textContent = `Status: ${progressData.status} (${progressData.completedFiles}/${progressData.totalFiles} files)`;

                    if (progressData.status === 'Complete') {
                        clearInterval(pollInterval);
                        downloadLink.href = `/download/${batchId}`;
                        downloadLink.textContent = 'Download Compressed Images (Click Here)';
                        downloadLink.style.display = 'block';
                        compressBtn.disabled = false;
                        selectedFiles = [];
                        fileInput.value = null;
                        updateFileListStatus();
                    } else if (progressData.status === 'Error' || progressData.status === 'Failed') {
                        clearInterval(pollInterval);
                        progressText.textContent = 'Status: Failed. Check server logs.';
                        compressBtn.disabled = false;
                    }
                }, 1000);
            } catch (error) {
                progressText.textContent = `Status: Error - ${error.message}`;
                compressBtn.disabled = false;
            }
        });

        updateFileListStatus();
    </script>
</body>
</html>